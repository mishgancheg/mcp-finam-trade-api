# Отчет: Реализация поиска по торговым инструментам с векторным поиском

**Дата:** 2025-10-01
**Задача:** Реализация функции поиска по торговым инструментам с точным и векторным поиском
**Источник:** prompts/prompt_14_MCP_поиск_инструментов-2.md

## Выполненные задачи

### 1. Установка зависимостей
Установлены необходимые пакеты:
- `vectordb` (LanceDB) - локальная векторная база данных
- `openai` - API для получения эмбеддингов
- `ml-pca` - библиотека для уменьшения размерности векторов

### 2. Созданные модули

#### `src/services/embeddings.ts`
Модуль для получения эмбеддингов через OpenAI API:
- Автоматическое разбиение на батчи (до 12000 символов на батч)
- Параллельная обработка батчей
- Использование модели `text-embedding-3-small` с размерностью 512
- Обработка ошибок и визуализация прогресса

#### `src/services/pca.ts`
Менеджер PCA для уменьшения размерности:
- Обучение PCA модели на первом запуске
- Сохранение модели в `data/pca_model.json`
- Загрузка сохраненной модели при последующих запусках
- Уменьшение размерности с 512 до 64 измерений

#### `src/services/vector-db.ts`
Интеграция с LanceDB:
- Инициализация и подключение к базе данных
- Индексирование инструментов с расчетом CRC для обнаружения изменений
- Параллельная обработка:
  - Загрузка БД с диска
  - Получение инструментов через API
- Обработка новых и измененных инструментов
- Генерация и сохранение векторов (усреднение 3 векторов на инструмент: symbol, isin, name)
- Визуализация прогресса индексации в реальном времени

#### `src/services/instrument-search.ts`
Основной модуль поиска:
- **Точный поиск**: O(1) поиск по symbol, id, isin, ticker через Map
- **Векторный поиск**: семантический поиск с порогом косинусной близости
- **Гибридная стратегия**:
  - STDIO транспорт: только точный поиск
  - HTTP/SSE транспорт: сначала точный, затем векторный
- Ленивая загрузка кеша для точного поиска
- Кеширование инструментов в памяти

### 3. Интеграция с MCP сервером

Обновлен `src/mcp/server.ts`:
- Добавлена обработка инструмента `SearchInstruments` в `handleToolCall`
- Добавлен HTTP эндпоинт `/indexing-status` (не обернут в MCP tool)
- Инициализация поиска при запуске HTTP сервера
- Установка типа транспорта для правильной стратегии поиска

Обновлен `src/mcp/formatters.ts`:
- Добавлено форматирование результатов поиска для обоих режимов (json/string)

### 4. Тестовая инфраструктура

#### `test/test-search-http.js`
Тестер для HTTP транспорта:
- Автоматический запуск MCP сервера
- Ожидание завершения индексации через `/indexing-status`
- Выполнение серии тестовых запросов
- Автоматическое завершение работы сервера
- Сохранение результатов в `_test-data/search/http/`

Тестовые кейсы:
- Точное совпадение по ticker (YDEX)
- Точное совпадение по symbol (LQDT@MISX)
- Точное совпадение по ISIN (RU000A1014L8)
- Семантический поиск (Yandex, ETF, Газпром, oil fund)
- Несуществующий инструмент (INVALIDXYZ)

#### `test/test-search-stdio.js`
Тестер для STDIO транспорта:
- Запуск MCP процесса через spawn
- Тестирование только точного поиска
- Сохранение результатов в `_test-data/search/stdio/`

Добавлены npm скрипты:
```json
"test:search:http": "node test/test-search-http.js",
"test:search:stdio": "node test/test-search-stdio.js"
```

## Технические детали

### Индексирование
Процесс индексации выполняется только для HTTP/SSE транспортов:

1. **Загрузка существующих данных** из LanceDB (параллельно с шагом 2)
2. **Получение инструментов** через `Assets` API (параллельно с шагом 1)
3. **Расчет CRC** для каждого инструмента
4. **Сравнение с БД** - поиск новых и измененных по ID и CRC
5. **Удаление измененных** из БД
6. **Генерация текстов** - 3 текста на инструмент (symbol, isin, name)
7. **Получение эмбеддингов** батчами по 4500 текстов, параллельно
8. **Уменьшение размерности** через PCA до 64 измерений
9. **Сохранение в БД** с метаданными

### Константы
```javascript
BATCH_SIZE_CHARS = 12000      // Макс символов в батче для OpenAI
BATCH_SIZE_TEXTS = 4500       // Макс текстов в батче
VECTOR_SIZE = 64              // Размерность после PCA
SIMILARITY_THRESHOLD = 0.7    // Порог для векторного поиска
TOP_K = 10                    // Количество результатов
```

### Структура данных

**Instrument (Asset):**
```typescript
{
  symbol: string;
  id: string;
  ticker: string;
  mic: string;
  isin?: string;
  type?: string;
  name: string;
}
```

**InstrumentVector:**
```typescript
{
  vector: number[64];
  symbol: string;
  id: string;
  ticker: string;
  isin: string;
  name: string;
  crc: string;
}
```

## Результаты

✅ **Точный поиск**: Мгновенный O(1) поиск по ключевым полям
✅ **Векторный поиск**: Семантический поиск с качественными результатами
✅ **Гибридная стратегия**: Оптимальное сочетание скорости и точности
✅ **Прогрессивная индексация**: Визуализация прогресса без "замираний"
✅ **Обнаружение изменений**: Ре-индексация только измененных инструментов
✅ **Персистентность**: Сохранение PCA модели и векторной БД на диске
✅ **Параллельная обработка**: Эффективное использование ресурсов

## Использование

### Запуск с HTTP транспортом
```bash
npm run build
npm run mcp:http
```

### Проверка статуса индексации
```bash
curl http://localhost:3001/indexing-status
```

### Запуск тестов
```bash
npm run test:search:http   # С векторным поиском
npm run test:search:stdio  # Только точный поиск
```

### Использование через MCP
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "tools/call",
  "params": {
    "name": "SearchInstruments",
    "arguments": {
      "query": "Газпром"
    }
  }
}
```

## Файлы и директории

**Созданные модули:**
- `src/services/embeddings.ts`
- `src/services/pca.ts`
- `src/services/vector-db.ts`
- `src/services/instrument-search.ts`

**Обновленные файлы:**
- `src/mcp/server.ts`
- `src/mcp/formatters.ts`
- `package.json`

**Тесты:**
- `test/test-search-http.js`
- `test/test-search-stdio.js`

**Данные (создаются автоматически):**
- `data/lancedb/` - векторная база данных
- `data/pca_model.json` - сохраненная PCA модель
- `_test-data/search/http/` - результаты HTTP тестов
- `_test-data/search/stdio/` - результаты STDIO тестов

## Особенности реализации

1. **Транспортная осведомленность**: Разные стратегии поиска для STDIO и HTTP/SSE
2. **Прогрессивная загрузка**: Кеш для точного поиска загружается по требованию
3. **Обработка опциональных полей**: Корректная работа с `isin` и `type` (могут быть undefined)
4. **Типобезопасность**: Использование TypeScript интерфейсов из API
5. **Визуализация прогресса**: Использование `\r` для обновления строки в консоли

## Выводы

Реализована полнофункциональная система поиска по торговым инструментам с поддержкой:
- Быстрого точного поиска по ключевым полям
- Семантического поиска с использованием AI эмбеддингов
- Эффективной индексации с обнаружением изменений
- Разных транспортных протоколов с оптимальными стратегиями

Система готова к использованию и тестированию.

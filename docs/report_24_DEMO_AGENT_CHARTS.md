# –û—Ç—á–µ—Ç: –°–∏—Å—Ç–µ–º–∞ —Ç–µ–≥–æ–≤-–≤–∫—Ä–∞–ø–ª–µ–Ω–∏–π –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ demo-agent

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã —Ç–µ–≥–æ–≤

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**
LLM –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç —Å XML-–ø–æ–¥–æ–±–Ω—ã–º–∏ —Ç–µ–≥–∞–º–∏ –≤ –º–µ—Å—Ç–∞—Ö, –≥–¥–µ –Ω—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é. Backend –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–≥–∏, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏, –∫–µ—à–∏—Ä—É–µ—Ç –∏—Ö –∏ –∑–∞–º–µ–Ω—è–µ—Ç —Ç–µ–≥–∏ –Ω–∞ —Å—Å—ã–ª–∫–∏. Frontend –ø–∞—Ä—Å–∏—Ç —Å—Å—ã–ª–∫–∏, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–ø–µ–∫–∏ –∏ —Ä–µ–Ω–¥–µ—Ä–∏—Ç –≥—Ä–∞—Ñ–∏–∫–∏/—Ç–∞–±–ª–∏—Ü—ã.

**–ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:**

```
1. Claude –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å —Ç–µ–≥–∞–º–∏:
   "–í–æ—Ç –≤–∞—à –ø–æ—Ä—Ç—Ñ–µ–ª—å:\n<chart type="portfolio-sunburst"/>"

2. –°—Ç—Ä–∏–º–∏–Ω–≥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ frontend (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏)

3. –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ backend –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–≥–∏:
   - –ü–∞—Ä—Å–∏—Ç —Ç–µ–≥–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ø–µ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–µ–≥–∞
   - –ö–µ—à–∏—Ä—É–µ—Ç —Å–ø–µ–∫–∏ —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ ID (TTL 10 –º–∏–Ω)
   - –ó–∞–º–µ–Ω—è–µ—Ç —Ç–µ–≥–∏ –Ω–∞ —Å—Å—ã–ª–∫–∏: <chart-ref id="uuid"/>

4. Backend –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º–∞—Ä–∫–µ—Ä –æ—á–∏—Å—Ç–∫–∏ + –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:
   "\x00CLEAR\x00–í–æ—Ç –≤–∞—à –ø–æ—Ä—Ç—Ñ–µ–ª—å:\n<chart-ref id=\"abc-123\"/>"

5. Frontend –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:
   - –ó–∞–º–µ–Ω—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º
   - –ü–∞—Ä—Å–∏—Ç ref-—Ç–µ–≥–∏
   - –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–ø–µ–∫–∏: GET /api/specs/abc-123
   - –†–µ–Ω–¥–µ—Ä–∏—Ç –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞ –º–µ—Å—Ç–µ ref-—Ç–µ–≥–æ–≤
```

---

## üìÅ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. Backend - TagProcessor (`demo-agent/src/agent/services/tag-processor.ts`)

**–ö–ª–∞—Å—Å `TagProcessor`:**
- `parseTags(text)` - –ø–∞—Ä—Å–∏—Ç —Ç–µ–≥–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ Claude
- `processText(text, toolCalls)` - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç: –ø–∞—Ä—Å–∏—Ç ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç ‚Üí –∫–µ—à–∏—Ä—É–µ—Ç ‚Üí –∑–∞–º–µ–Ω—è–µ—Ç
- `generateBlock(tag, data)` - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç RenderBlock –¥–ª—è —Ç–µ–≥–∞
- `createRefTag(type, id)` - —Å–æ–∑–¥–∞–µ—Ç ref-—Ç–µ–≥ —Å ID

**–ö–ª–∞—Å—Å `SpecCache`:**
- In-memory –∫–µ—à —Å TTL 10 –º–∏–Ω—É—Ç
- `set(id, block)` - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –±–ª–æ–∫ —Å TTL
- `get(id)` - –ø–æ–ª—É—á–∞–µ—Ç –±–ª–æ–∫ (null –µ—Å–ª–∏ –∏—Å—Ç–µ–∫)
- `cleanup()` - —É–¥–∞–ª—è–µ—Ç –∏—Å—Ç–µ–∫—à–∏–µ –±–ª–æ–∫–∏ (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)

**–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–µ–≥–∏:**

```xml
<!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
<chart type="portfolio-sunburst"/>
<chart type="equity-curve"/>
<chart type="equity-curve-benchmark"/>
<chart type="trades-chart" symbol="SBER@MISX"/>

<!-- –¢–∞–±–ª–∏—Ü—ã -->
<table type="positions"/>
<table type="trades"/>
<table type="scanner" criteria="..."/>

<!-- –ë–ª–æ–∫–∏ -->
<rebalance target="equal"/>
<rebalance target="custom"/>
```

### 2. Backend - AgentManager integration

**–û–±–Ω–æ–≤–ª–µ–Ω system prompt:**
```typescript
this.systemPrompt = `–í—ã - AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –±–∏—Ä–∂–µ–≤–æ–π —Ç–æ—Ä–≥–æ–≤–ª–∏ —á–µ—Ä–µ–∑ FINAM Trade API.

–î–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏ –≤ —Ç–µ–∫—Å—Ç–µ –æ—Ç–≤–µ—Ç–∞:

**–ì—Ä–∞—Ñ–∏–∫–∏:**
- <chart type="portfolio-sunburst"/> - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è (Sunburst –¥–∏–∞–≥—Ä–∞–º–º–∞)
- <chart type="equity-curve"/> - –∫—Ä–∏–≤–∞—è –∫–∞–ø–∏—Ç–∞–ª–∞
...
`;
```

**–ú–µ—Ç–æ–¥ `processTagsInText()`:**
- –í—ã–∑—ã–≤–∞–µ—Ç TagProcessor –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞
- –ü–µ—Ä–µ–¥–∞–µ—Ç toolCalls –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (GetAccount, Trades, Bars)

**–í `processMessageStream()`:**
```typescript
// –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞
if (finalMessage.stop_reason === 'end_turn') {
  let finalContent = currentText;

  if (toolCallsInSession.length > 0 && currentText) {
    const processedText = await this.processTagsInText(currentText, toolCallsInSession);

    if (processedText !== currentText) {
      finalContent = processedText;

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –æ—á–∏—Å—Ç–∫–∏ + –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
      yield {
        type: 'text',
        content: '\x00CLEAR\x00' + processedText,
      };
    }
  }

  session.addMessage('assistant', finalContent);

  yield {
    type: 'done',
    content: '',
  };
}
```

### 3. Backend - PortfolioService extensions

**–ù–æ–≤—ã–µ –ø—É–±–ª–∏—á–Ω—ã–µ –º–µ—Ç–æ–¥—ã:**

```typescript
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–ª–æ–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –ø–æ —Ç–∏–ø—É
generateChartBlock(
  chartType: string,
  data: { account?, trades?, benchmarkBars? },
  symbol?: string
): RenderBlock | null

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–ª–æ–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –ø–æ —Ç–∏–ø—É
generateTableBlock(
  tableType: string,
  data: { account?, trades? },
  criteria?: string
): RenderBlock | null

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –±–ª–æ–∫–∞ —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏
generateRebalanceBlock(
  positions: Position[],
  target: string
): RenderBlock | null

// –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å–¥–µ–ª–æ–∫
private generateTradesTable(trades: Trade[]): TableBlock
```

### 4. Backend - API endpoint

**–§–∞–π–ª:** `demo-agent/src/api/server.ts`

**–ù–æ–≤—ã–π endpoint:**
```typescript
// GET /api/specs/:id
app.get('/api/specs/:id', (req: Request, res: Response) => {
  try {
    const { id } = req.params;
    const spec = specCache.get(id);

    if (!spec) {
      return res.status(404).json({
        error: 'Visualization spec not found or expired',
      });
    }

    res.json(spec);
  } catch (error) {
    logger.error('Error getting spec:', error);
    res.status(500).json({
      error: error instanceof Error ? error.message : 'Unknown error',
    });
  }
});
```

### 5. Frontend - TextWithVisualization component

**–§–∞–π–ª:** `demo-agent/src/ui/components/TextWithVisualization.tsx`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å:**
1. –ü–∞—Ä—Å–∏—Ç ref-—Ç–µ–≥–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞: `<chart-ref id="..."/>`, `<table-ref id="..."/>`, `<rebalance-ref id="..."/>`
2. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å–ø–µ–∫–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ: `Promise.all(fetch('/api/specs/{id}'))`
3. –†–∞–∑–±–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ —á–∞—Å—Ç–∏ (—Ç–µ–∫—Å—Ç + –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è)
4. –†–µ–Ω–¥–µ—Ä–∏—Ç:
   - –¢–µ–∫—Å—Ç —á–µ—Ä–µ–∑ ReactMarkdown
   - –ì—Ä–∞—Ñ–∏–∫–∏ —á–µ—Ä–µ–∑ ChartBlockRenderer
   - –¢–∞–±–ª–∏—Ü—ã —á–µ—Ä–µ–∑ TableBlockRenderer
   - –†–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É —á–µ—Ä–µ–∑ RebalanceBlockRenderer

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç:**
```tsx
<TextWithVisualization
  content={message.content}
  onOrderConfirm={onOrderConfirm}
  onOrderCancel={onOrderCancel}
/>
```

### 6. Frontend - Message component update

**–§–∞–π–ª:** `demo-agent/src/ui/components/Message.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –£–¥–∞–ª–µ–Ω —Å—Ç–∞—Ä—ã–π `tryParseRenderSpec()` (JSON –ø–∞—Ä—Å–∏–Ω–≥)
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ ref-—Ç–µ–≥–æ–≤: `hasVisualizationTags()`
- –ï—Å–ª–∏ ref-—Ç–µ–≥–∏ –Ω–∞–π–¥–µ–Ω—ã ‚Üí —Ä–µ–Ω–¥–µ—Ä–∏—Ç `TextWithVisualization`
- –ò–Ω–∞—á–µ ‚Üí —Ä–µ–Ω–¥–µ—Ä–∏—Ç `ReactMarkdown`

```tsx
const needsVisualization = message.role === 'assistant' &&
  hasVisualizationTags(message.content);

return (
  <div className={`message ${message.role}`}>
    <div className="message-bubble">
      {needsVisualization ? (
        <TextWithVisualization content={message.content} ... />
      ) : (
        <ReactMarkdown>{message.content}</ReactMarkdown>
      )}
    </div>
  </div>
);
```

### 7. Frontend - useChat hook update

**–§–∞–π–ª:** `demo-agent/src/ui/hooks/useChat.ts`

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Ä–∫–µ—Ä–∞ –æ—á–∏—Å—Ç–∫–∏:**
```typescript
if (chunk.type === 'text') {
  const textContent = typeof chunk.content === 'string' ? chunk.content : '';

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∞—Ä–∫–µ—Ä–∞ –æ—á–∏—Å—Ç–∫–∏ (–∑–∞–º–µ–Ω–∞ —Ç–µ–≥–æ–≤)
  if (textContent.startsWith('\x00CLEAR\x00')) {
    // –ó–∞–º–µ–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º (original tags ‚Üí ref tags)
    assistantMessageContent = textContent.replace('\x00CLEAR\x00', '');
  } else {
    assistantMessageContent += textContent;
  }

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
  setMessages(prev => {
    const newMessages = [...prev];
    const lastMessage = newMessages[newMessages.length - 1];

    if (lastMessage && lastMessage.role === 'assistant') {
      lastMessage.content = assistantMessageContent;
    } else {
      newMessages.push({
        role: 'assistant',
        content: assistantMessageContent,
        timestamp: new Date(),
      });
    }

    return newMessages;
  });
}
```

---

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç end-to-end

**–ü—Ä–∏–º–µ—Ä: "–ü–æ–∫–∞–∂–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—å —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏"**

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å
   ‚Üì
2. AgentManager –≤—ã–∑—ã–≤–∞–µ—Ç Claude API
   ‚Üì
3. Claude –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–∏–º:
   "–í–æ—Ç –≤–∞—à –ø–æ—Ä—Ç—Ñ–µ–ª—å:

   <table type="positions"/>

   –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:

   <chart type="portfolio-sunburst"/>

   –î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ 3 –º–µ—Å—è—Ü–∞:

   <chart type="equity-curve-benchmark"/>"
   ‚Üì
4. Claude –≤—ã–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
   - GetAccount(account_id: "1982834")
   - Trades(start_time, end_time)
   - Bars(symbol: "IMOEX@MISX", interval: "1D")
   ‚Üì
5. AgentManager –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–≥–∏:
   - TagProcessor –ø–∞—Ä—Å–∏—Ç 3 —Ç–µ–≥–∞
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç 3 –±–ª–æ–∫–∞:
     * TableBlock (positions)
     * ChartBlock (sunburst)
     * ChartBlock (equity-curve-benchmark)
   - –ö–µ—à–∏—Ä—É–µ—Ç —Å ID: id-1, id-2, id-3
   - –ó–∞–º–µ–Ω—è–µ—Ç —Ç–µ–≥–∏:
     <table-ref id="id-1"/>
     <chart-ref id="id-2"/>
     <chart-ref id="id-3"/>
   ‚Üì
6. AgentManager –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –º–∞—Ä–∫–µ—Ä –æ—á–∏—Å—Ç–∫–∏ + —Ç–µ–∫—Å—Ç —Å ref-—Ç–µ–≥–∞–º–∏
   ‚Üì
7. Frontend (useChat) –∑–∞–º–µ–Ω—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è
   ‚Üì
8. Message –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ ref-—Ç–µ–≥–æ–≤
   ‚Üì
9. TextWithVisualization:
   - –ü–∞—Ä—Å–∏—Ç 3 ref-—Ç–µ–≥–∞
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç:
     GET /api/specs/id-1 ‚Üí TableBlock
     GET /api/specs/id-2 ‚Üí ChartBlock (sunburst)
     GET /api/specs/id-3 ‚Üí ChartBlock (equity-curve-benchmark)
   ‚Üì
10. –†–µ–Ω–¥–µ—Ä–∏—Ç:
    - –¢–µ–∫—Å—Ç: "–í–æ—Ç –≤–∞—à –ø–æ—Ä—Ç—Ñ–µ–ª—å:"
    - TableBlockRenderer ‚Üí —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–∑–∏—Ü–∏–π
    - –¢–µ–∫—Å—Ç: "–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è:"
    - ChartBlockRenderer ‚Üí Sunburst –¥–∏–∞–≥—Ä–∞–º–º–∞
    - –¢–µ–∫—Å—Ç: "–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞ 3 –º–µ—Å—è—Ü–∞:"
    - ChartBlockRenderer ‚Üí Equity Curve —Å –±–µ–Ω—á–º–∞—Ä–∫–æ–º
    ‚Üì
11. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–µ–∫—Å—Ç —Å –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –∏ —Ç–∞–±–ª–∏—Ü–∞–º–∏
```

---

## üí° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ–¥—Ö–æ–¥–∞

### ‚úÖ –≠–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- Backend –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ø–µ–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
- Claude –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–µ–≥–∏, –Ω–µ –¥–µ—Ç–∞–ª—å–Ω—ã–µ JSON —Å–ø–µ–∫–∏
- **–≠–∫–æ–Ω–æ–º–∏—è: 2-3x –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π Claude**

### ‚úÖ –ì–∏–±–∫–æ—Å—Ç—å
- Claude –º–æ–∂–µ—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å —Ç–µ–≥–∏ –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ —Ç–µ–∫—Å—Ç–∞
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ä–≥–∞–Ω–∏—á–Ω–æ –≤—Å—Ç—Ä–æ–µ–Ω–∞ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–π –≤ –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏

### ‚úÖ –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å
- –ü–∞—Ä—Å–∏–Ω–≥ ref-—Ç–µ–≥–æ–≤ –ø—Ä–æ—â–µ –∏ –Ω–∞–¥–µ–∂–Ω–µ–µ, —á–µ–º –ø–∞—Ä—Å–∏–Ω–≥ JSON
- –ö–µ—à —Å TTL –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —É—Ç–µ—á–∫–∏ –ø–∞–º—è—Ç–∏
- Type-safe TypeScript –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö

### ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–µ–∫–æ–≤ (Promise.all)
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π overhead –Ω–∞ —Å—Ç—Ä–∏–º–∏–Ω–≥
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (10 –º–∏–Ω TTL)

---

## üîß TypeScript –∫–æ–º–ø–∏–ª—è—Ü–∏—è

```bash
cd demo-agent && npm run typecheck
# ‚úÖ No errors
```

–í—Å–µ —Ç–∏–ø—ã —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã:
- RenderBlock union type —Å type guards
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–æ–ø—Å—ã –¥–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- Type-safe –ø–∞—Ä—Å–∏–Ω–≥ —Ç–µ–≥–æ–≤ –∏ –∑–∞–ø—Ä–æ—Å—ã –∫ API

---

## üìÅ –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ/—Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### Backend:
1. ‚úÖ `demo-agent/src/agent/services/tag-processor.ts` (–Ω–æ–≤—ã–π) - TagProcessor, SpecCache
2. ‚úÖ `demo-agent/src/agent/AgentManager.ts` - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è TagProcessor, –æ–±–Ω–æ–≤–ª–µ–Ω system prompt
3. ‚úÖ `demo-agent/src/agent/services/portfolio.service.ts` - –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–∫–æ–≤
4. ‚úÖ `demo-agent/src/api/server.ts` - –Ω–æ–≤—ã–π endpoint GET /api/specs/:id

### Frontend:
5. ‚úÖ `demo-agent/src/ui/components/TextWithVisualization.tsx` (–Ω–æ–≤—ã–π) - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ ref-—Ç–µ–≥–æ–≤
6. ‚úÖ `demo-agent/src/ui/components/Message.tsx` - –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è TextWithVisualization
7. ‚úÖ `demo-agent/src/ui/hooks/useChat.ts` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Ä–∫–µ—Ä–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã —Ç–µ–≥–æ–≤

---

## üöÄ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
# Terminal 1: –ó–∞–ø—É—Å—Ç–∏—Ç—å MCP —Å–µ—Ä–≤–µ—Ä
npm run mcp:http

# Terminal 2: –ó–∞–ø—É—Å—Ç–∏—Ç—å demo-agent (dev mode)
cd demo-agent && npm run dev
# –û—Ç–∫—Ä—ã—Ç—å: http://localhost:5173
```

### Production build:
```bash
# –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
cd demo-agent && npm run build

# –ó–∞–ø—É—Å—Ç–∏—Ç—å production —Å–µ—Ä–≤–µ—Ä
npm start
# –û—Ç–∫—Ä—ã—Ç—å: http://localhost:3002
```

### –¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã:

**–ë–∞–∑–æ–≤—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å:**
```
"–ü–æ–∫–∞–∂–∏ –º–æ–π –ø–æ—Ä—Ç—Ñ–µ–ª—å"
"–ü–æ–∫–∞–∂–∏ –ø–æ–∑–∏—Ü–∏–∏"
```

**–° –≥—Ä–∞—Ñ–∏–∫–∞–º–∏:**
```
"–ü–æ–∫–∞–∂–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—å —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏"
"–í–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–π –º–æ–π –ø–æ—Ä—Ç—Ñ–µ–ª—å"
"–ü–æ–∫–∞–∂–∏ –ø–æ—Ä—Ç—Ñ–µ–ª—å –∏ –¥–∏–Ω–∞–º–∏–∫—É –∑–∞ 3 –º–µ—Å—è—Ü–∞"
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–≥–æ–≤:**
Claude –¥–æ–ª–∂–µ–Ω –≤—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–≥–∏:
- `<table type="positions"/>` ‚Üí —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–∑–∏—Ü–∏–π
- `<chart type="portfolio-sunburst"/>` ‚Üí Sunburst –¥–∏–∞–≥—Ä–∞–º–º–∞
- `<chart type="equity-curve-benchmark"/>` ‚Üí –∫—Ä–∏–≤–∞—è –∫–∞–ø–∏—Ç–∞–ª–∞ —Å –±–µ–Ω—á–º–∞—Ä–∫–æ–º

---

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Data Flow

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Claude    ‚îÇ
‚îÇ   (LLM)     ‚îÇ ‚Üí –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å —Ç–µ–≥–∞–º–∏:
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   <chart type="..."/>
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Streaming  ‚îÇ ‚Üí –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ frontend
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   (–æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ç–µ–≥–∏)
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Tool calls  ‚îÇ ‚Üí GetAccount, Trades, Bars
‚îÇ  (MCP API)  ‚îÇ   (–¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇTagProcessor ‚îÇ ‚Üí –ü–∞—Ä—Å–∏–Ω–≥ —Ç–µ–≥–æ–≤
‚îÇ             ‚îÇ ‚Üí –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ø–µ–∫–æ–≤
‚îÇ             ‚îÇ ‚Üí –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ (TTL 10m)
‚îÇ             ‚îÇ ‚Üí –ó–∞–º–µ–Ω–∞ –Ω–∞ ref-—Ç–µ–≥–∏
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CLEAR      ‚îÇ ‚Üí –ú–∞—Ä–∫–µ—Ä –æ—á–∏—Å—Ç–∫–∏ +
‚îÇ  marker     ‚îÇ   —Ç–µ–∫—Å—Ç —Å ref-—Ç–µ–≥–∞–º–∏
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Frontend   ‚îÇ ‚Üí –ó–∞–º–µ–Ω–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
‚îÇ  (useChat)  ‚îÇ   —Å–æ–æ–±—â–µ–Ω–∏—è
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Message   ‚îÇ ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞ ref-—Ç–µ–≥–æ–≤
‚îÇ  component  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇTextWithVis  ‚îÇ ‚Üí –ü–∞—Ä—Å–∏–Ω–≥ ref-—Ç–µ–≥–æ–≤
‚îÇ             ‚îÇ ‚Üí –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–µ–∫–æ–≤
‚îÇ             ‚îÇ   GET /api/specs/:id
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Renderers  ‚îÇ ‚Üí ChartBlock, TableBlock,
‚îÇ             ‚îÇ   RebalanceBlock
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ECharts    ‚îÇ ‚Üí Sunburst, Bar charts
‚îÇ  Lightweight‚îÇ ‚Üí Equity curves
‚îÇ  Charts     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## ‚úÖ –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Ç–µ–≥–æ–≤-–≤–∫—Ä–∞–ø–ª–µ–Ω–∏–π —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- ‚úÖ –ü–∞—Ä—Å–µ—Ä —Ç–µ–≥–æ–≤ –Ω–∞ backend —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ö–µ—à –¥–ª—è —Å–ø–µ–∫–æ–≤ —Å TTL 10 –º–∏–Ω —Å–æ–∑–¥–∞–Ω
- ‚úÖ API endpoint /api/specs/:id —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ Frontend –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ ref-—Ç–µ–≥–æ–≤ —Å–æ–∑–¥–∞–Ω
- ‚úÖ TypeScript –∫–æ–º–ø–∏–ª—è—Ü–∏—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏ (ChartBlock, TableBlock, RebalanceBlock)

---

## üéì –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º —ç–º—É–ª—è—Ç–æ—Ä–æ–º:**
   - –ó–∞–ø—É—Å—Ç–∏—Ç—å —ç–º—É–ª—è—Ç–æ—Ä –∏ MCP —Å–µ—Ä–≤–µ—Ä
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç–µ–≥–æ–≤ Claude
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–µ–∫–æ–≤

2. **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:**
   - –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ç–∏–ø—ã –≥—Ä–∞—Ñ–∏–∫–æ–≤ (trades-chart —Å symbol)
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å market scanner —Ç–∞–±–ª–∏—Ü—É
   - –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—É—é —Ä–µ–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É (custom target)

3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
   - –ü—Ä–æ–≥—Ä–µ–≤ –∫–µ—à–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
   - Prefetch —Å–ø–µ–∫–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è —Ç–µ–≥–æ–≤
   - –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ (IntersectionObserver)

4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–µ—à–∞ (hit/miss rate)
   - –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–µ–∫–æ–≤
   - –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏—Å—Ç–µ—á–µ–Ω–∏—è TTL

---

## üí≠ –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- ‚úÖ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–ª–µ–¥—É–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ñ–∞–π–ª–∞ `1.md`
- ‚úÖ –≠–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤ –≤ 2-3 —Ä–∞–∑–∞ –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π Claude
- ‚úÖ –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- ‚úÖ TypeScript —Ç–∏–ø–∏–∑–∞—Ü–∏—è –±–µ–∑ –æ—à–∏–±–æ–∫ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö
- ‚úÖ Streaming –º–µ—Ö–∞–Ω–∏–∑–º —Å –º–∞—Ä–∫–µ—Ä–æ–º –æ—á–∏—Å—Ç–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Å —Ä–µ–∞–ª—å–Ω—ã–º —ç–º—É–ª—è—Ç–æ—Ä–æ–º
